{% extends "base.html" %}
{% load i18n %}

{% block head_css %}
<style>
	h3 { margin-bottom: .5em; }
	fieldset { margin-bottom: 1em; }
	label {
		font-weight: normal;
		font-size: 80%;
		width: 14ex;
	}
	#person_part label {
		float: left;
		display: block;
		line-height: 22px;
	}
	input[type="submit"] {
		padding: 5px 7px;
		font-weight: bold;
		font-size: 100%;
	}
	form ul { list-style: none; }
	.list-r { margin-bottom: 1em; }
	.list-r a { color: #00F; }
	.errorlist { font-size: 80%; color: #F00; margin-left: 10px; }
	.error-message { color: #F00; }
	#datepicker { margin-top: 2em; margin-bottom: 1em; }
	.ui-selectable { list-style-type: none; margin: 0; padding: 0; }
	.ui-selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 30px; }
	.ui-selectable .ui-selected { background: #F39814; color: white; }
	{% if user.is_authenticated %}
	.ui-selectable .ui-status-1 { color: #CCC; }
	.ui-selectable .ui-status-3 { color: #0A0; }
	.ui-selectable .ui-status-4 { color: #A00; }
	{% else %}
	.ui-selectable .ui-disabled { color: #CCC; }
	{% endif %}
</style>
{% endblock %}


{% block page_container %}
<form class="grid_4" action="." method="post">
	<fieldset id="person_part">
		{% if message %}<p class="error-message">{{ message }}</p>{% endif %}
		{% csrf_token %}
		{{ form.ident_hash.label_tag }}{{ form.ident_hash }}{{ form.ident_hash.errors }}
		{{ form.first_name.label_tag }}{{ form.first_name }}{{ form.first_name.errors }}
		{{ form.last_name.label_tag }}{{ form.last_name }}{{ form.last_name.errors }}
		{{ form.phone_number.label_tag }}{{ form.phone_number }}{{ form.phone_number.errors }}
		{{ form.email.label_tag }}{{ form.email }}{{ form.email.errors }}
	</fieldset>
	<fieldset id="visit_part">
		{{ form.reservation }}{{ form.reservation.errors }}
		{{ form.exam_kind.label_tag }}{{ form.exam_kind }}{{ form.exam_kind.errors }}
	</fieldset>
	<div id="datepicker"></div>
	<button type="submit">{% trans "Book reservation" %}</button>
</form>

<div class="grid_8" id="datetime">
	<div id="tabs">
		<ul>
		{% for place in places %}
			<li><a href="#tab-{{ place.id }}">{{ place.name }}</a></li>
		{% endfor %}
		</ul>
		{% for place in places %}
		<div id="tab-{{ place.id }}">
			<h3>De≈à: <span class="actual-date">{{ actual_date|date:"d.m.Y" }}</span></h3>
			{% if user.is_authenticated %}
			<p class="list-r"><a href="#"><input type="hidden" value="{{ place.id }}" class="place-id" />{% trans "List of reservations" %}</a></p>
			{% endif %}
			<ol class="ui-selectable">
				{% for r in place.reservations %}
				<li class="ui-widget-content ui-selectee{% if r.id == reservation_id %} ui-selected{% endif %} {% spaceless %}
					{% if user.is_authenticated %}
						ui-status-{{ r.status }}
					{% else %}
						{% if r.status != 2 %}ui-disabled{% endif %}
					{% endif %}{% endspaceless %}">
					<input type="hidden" value="{{ r.id }}" />
					{{ r.starting_time|date:"H:i" }}
					{% if user.is_authenticated and r.status == 3 %} <span class="patient-name">{{ r.patient.full_name }}</span>{% endif %}
				</li>
				{% endfor %}
			</ol>
		</div>
		{% endfor %}
	</div>
</div>

{% endblock %}

{% block footer_js_page %}
<script type="text/javascript">
$(function() {
	function select_reservation(elem){
		$(".ui-selected").removeClass("ui-selected");
		elem.addClass("ui-selected");
		$("#id_reservation").val($("input[type='hidden']", $(this)).val());
	}

	{% if user.is_authenticated %}
	// code source: http://docs.djangoproject.com/en/1.3/ref/contrib/csrf/
	$('html').ajaxSend(function(event, xhr, settings) {
		function getCookie(name) {
			var cookieValue = null;
			if (document.cookie && document.cookie != '') {
				var cookies = document.cookie.split(';');
				for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					// Does this cookie string begin with the name we want?
					if (cookie.substring(0, name.length + 1) == (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}
		if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
			// Only send the token to relative URLs i.e. locally.
			xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
		}
	});

	$(".list-r a").click(function(){
		var place = $(".place-id", $(this)).val();
		var date_str = $.datepicker.formatDate("yy-mm-dd", $("#datepicker").datepicker("getDate"));
		var url = "/reservations/"+ date_str +"/list/"+ place +"/";
		$(this).attr("href", url)
	});

	$("#id_ident_hash").focusout(function(){
		var ident_hash = $(this).val();
		if(ident_hash != ""){
			$.post("/patient/", {ident_hash: ident_hash}, function(data){
				if(data.first_name) $("#id_first_name").val(data.first_name);
				if(data.last_name) $("#id_last_name").val(data.last_name);
				if(data.phone_number) $("#id_phone_number").val(data.phone_number);
				if(data.email) $("#id_email").val(data.email);
			});
		}
	});

	$(".ui-selectable li").live("click", function(){
		var elem = $(this);
		var tab = elem.parent().parent();
		var r_id = $("input[type='hidden']", elem).val();

		$(".act-button", tab).remove();

		function add_button(text, func){
			$("<button></button>")
				.html(text)
				.addClass("act-button")
				.appendTo(tab)
				.button()
				.click(func);
		}

		function display_message(title, text){
			$("<div></div>")
				.html(text)
				.appendTo("body")
				.dialog({
					title: title,
					close: function(event, ui){
						$(this).dialog("destroy").remove();
					}
				});
		}

		if(elem.hasClass("ui-status-2")){
			$.getJSON("/reservations/"+ r_id +"/hold/", function(data){
				if(data.status_ok){
					elem.removeClass("ui-status-2")
						.addClass("ui-status-4");
				} else {
					display_message(
						"{% trans "Message" %}",
						"{% trans "The hold operation failed" %}"
					);
				}
			});
		}

		select_reservation($(this));

		{% if user.is_staff %}
		if(elem.hasClass("ui-status-1")){
			add_button("{% trans "Enable" %}", function(){
				$.getJSON("/reservations/"+ r_id +"/enable/", function(data){
					if(data.status_ok){
						elem.removeClass("ui-status-1").addClass("ui-status-2");
						$(".ui-selected", tab).removeClass("ui-selected");
						$(".act-button", tab).remove();
					} else {
						display_message(
							"{% trans "Message" %}",
							"{% trans "The enable operation failed" %}"
						);
					}
				});

			});
		}
		{% endif %}

		if(elem.hasClass("ui-status-3")){
			add_button("{% trans "Unbook" %}", function(){
				$.getJSON("/reservations/"+ r_id +"/unbook/", function(data){
					if(data.status_ok){
						elem.removeClass("ui-status-3").addClass("ui-status-2");
						$(".patient-name", elem).remove();
						$(".ui-selected", tab).removeClass("ui-selected");
						$(".act-button", tab).remove();
					} else {
						display_message(
							"{% trans "Message" %}",
							"{% trans "The unbook operation failed" %}"
						);
					}
				});

			});
		}

		if(elem.hasClass("ui-status-4")){
			add_button("{% trans "Unhold" %}", function(){
				$.getJSON("/reservations/"+ r_id +"/unhold/", function(data){
					if(data.status_ok){
						elem.removeClass("ui-status-4").addClass("ui-status-2");
						$(".ui-selected", tab).removeClass("ui-selected");
						$(".act-button", tab).remove();
					} else {
						display_message(
							"{% trans "Message" %}",
							"{% trans "The unhold operation failed" %}"
						);
					}
				});
			});
			{% if user.is_staff %}
			add_button("{% trans "Disable" %}", function(){
				$.getJSON("/reservations/"+ r_id +"/disable/", function(data){
					if(data.status_ok){
						elem.removeClass("ui-status-4").addClass("ui-status-1");
						$(".ui-selected", tab).removeClass("ui-selected");
						$(".act-button", tab).remove();
					} else {
						display_message(
							"{% trans "Message" %}",
							"{% trans "The disable operation failed" %}"
						);
					}
				});

			});
			{% endif %}
		}
	});

	function make_reservation_item(r, rlist){
		$("<li></li>")
			.addClass("ui-widget-content ui-selectee ui-status-"+ r.status)
			.html(r.time)
			.appendTo(rlist)
			.prepend($("<input>").attr({
				type: "hidden",
				value: r.id
			}))
			.append(" "+ r.patient);
	}
	{% else %}
	$(".ui-selectable li").live("click", function(){
		if(!$(this).hasClass("ui-disabled")){ select_reservation($(this)); }
	});

	function make_reservation_item(r, rlist){
		var disabled_class = r.disabled ? " ui-disabled" : "";
		$("<li></li>")
			.addClass("ui-widget-content ui-selectee"+ disabled_class)
			.html(r.time)
			.appendTo(rlist)
			.prepend($("<input>").attr({
				type: "hidden",
				value: r.id
			}));
	}
	{% endif %}

	var tabs = $("#tabs").tabs();

	$("#datepicker").datepicker({
		defaultDate: "{{ actual_date|date:"Y-m-d" }}",
		minDate: "{{ actual_date|date:"Y-m-d" }}",
		dateFormat: "yy-mm-dd",
		onSelect: function(dateText, inst){
			var date_str = $.datepicker.formatDate("dd.mm.yy", $(this).datepicker("getDate"));
			var url = "/reservations/"+ dateText +"/";
			$.getJSON(url, function(data){
				$(".actual-date").html(date_str);
				$.each(data, function(i, place){
					var rlist = $("#tab-"+ place.place_id +" .ui-selectable", tabs);
					rlist.empty();
					$.each(place.reservations, function(i, r){
						make_reservation_item(r, rlist);
					});
				});
			});
		}
	});
});
</script>
{% endblock %}
